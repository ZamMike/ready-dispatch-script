/* ===== READY Custom Date Range - NEW LOGIC ===== */
/* –ß–µ—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å —è–≤–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫ */

/************** TABLE STRUCTURE **************/
const TABLE_STRUCTURE = {
  // –ë–∞–∑–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (–≤—Å–µ–≥–¥–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ)
  base: {
    rpm: 'A',
    gross: 'B',
    pickyOrNot: 'C',
    weakStrong: 'D',
    dispatcher: 'E',
    driver: 'F'
  },

  // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ (–ø—É—Å—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏)
  separators: {
    afterDrivers: 'G',      // –ø–æ—Å–ª–µ F
    afterWeek34: 'L',       // –ø–æ—Å–ª–µ WEEK 34
    afterWeek35: 'T',       // –ø–æ—Å–ª–µ WEEK 35 –¥–Ω–µ–π
    afterWeek35Notes: 'V',  // –ø–æ—Å–ª–µ WEEK 35 NOTES
    afterWeek35Block: 'X',  // –ø–æ—Å–ª–µ –≤—Å–µ–≥–æ –±–ª–æ–∫–∞ WEEK 35
    // –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞...
  },

  // –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª—å (–æ–¥–∏–Ω–æ—á–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏)
  historyWeeks: {
    week31: 'H',
    week32: 'I',
    week33: 'J',
    week34: 'K'
  },

  // –ü–æ–ª–Ω—ã–µ –Ω–µ–¥–µ–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ (7 –¥–Ω–µ–π + WEEK Gross + —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å + NOTES)
  weekBlocks: {
    week35: {
      day1: 'M',
      day2: 'N',
      day3: 'O',
      day4: 'P',
      day5: 'Q',
      day6: 'R',
      day7: 'S',
      separator: 'T',
      weekGross: 'U',
      separator2: 'V',
      notes: 'W',
      separator3: 'X'
    },
    week36: {
      day1: 'Y',
      day2: 'Z',
      day3: 'AA',
      day4: 'AB',
      day5: 'AC',
      day6: 'AD',
      day7: 'AE',
      separator: 'AF',
      weekGross: 'AG',
      separator2: 'AH',
      notes: 'AI',
      separator3: 'AJ'
    },
    week37: {
      day1: 'AK',
      day2: 'AL',
      day3: 'AM',
      day4: 'AN',
      day5: 'AO',
      day6: 'AP',
      day7: 'AQ',
      separator: 'AR',
      weekGross: 'AS',
      separator2: 'AT',
      notes: 'AU',
      separator3: 'AV'
    },
    week38: {
      day1: 'AW',
      day2: 'AX',
      day3: 'AY',
      day4: 'AZ',
      day5: 'BA',
      day6: 'BB',
      day7: 'BC',
      separator: 'BD',
      weekGross: 'BE',
      separator2: 'BF',
      notes: 'BG',
      separator3: 'BH'
    },
    week39: {
      day1: 'BI',
      day2: 'BJ',
      day3: 'BK',
      day4: 'BL',
      day5: 'BM',
      day6: 'BN',
      day7: 'BO',
      separator: 'BP',
      weekGross: 'BQ',
      separator2: 'BR',
      notes: 'BS',
      separator3: 'BT'
    },
    week40: {
      day1: 'BU',
      day2: 'BV',
      day3: 'BW',
      day4: 'BX',
      day5: 'BY',
      day6: 'BZ',
      day7: 'CA',
      separator: 'CB',
      weekGross: 'CC',
      separator2: 'CD',
      notes: 'CE',
      separator3: 'CF'
    },
    week41: {
      day1: 'CG',
      day2: 'CH',
      day3: 'CI',
      day4: 'CJ',
      day5: 'CK',
      day6: 'CL',
      day7: 'CM',
      separator: 'CN',
      weekGross: 'CO',
      separator2: 'CP',
      notes: 'CQ',
      separator3: 'CR'
    }
    // WEEK 42-50 –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–∑–∂–µ –∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞–¥—É—Ç—Å—è
  }
};

/************** CONFIGURATION **************/
const CONFIG = {
  teams: ['Team 1', 'Team 2', 'Team 3', 'Team 4', 'Team 5'],
  dataStartRow: 2, // –¥–∞–Ω–Ω—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å —Å—Ç—Ä–æ–∫–∏ 2 (—Å—Ç—Ä–æ–∫–∞ 1 = –∑–∞–≥–æ–ª–æ–≤–∫–∏)
  timezone: 'America/Chicago',

  // –ö—Ä–∞—Å–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è READY
  redColors: new Set([
    '#ff0000', '#ff5b5b', '#ff6666', '#f44336', '#ea4335',
    '#d32f2f', '#e06666', '#ea9999'
  ]),

  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞ (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞)
  weekBlockPattern: {
    daysCount: 7,         // 7 –¥–Ω–µ–π
    stepSize: 12,         // –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ 12 –∫–æ–ª–æ–Ω–æ–∫
    dayToGrossOffset: 8,  // –æ—Ç day1 –¥–æ weekGross = 8 –∫–æ–ª–æ–Ω–æ–∫ (M -> U)
    dayToNotesOffset: 10  // –æ—Ç day1 –¥–æ notes = 10 –∫–æ–ª–æ–Ω–æ–∫ (M -> W)
  }
};

/************** UTILITY FUNCTIONS **************/

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –±—É–∫–≤—ã –∫–æ–ª–æ–Ω–∫–∏ –≤ –∏–Ω–¥–µ–∫—Å
function colLetterToIndex(letter) {
  if (!letter || typeof letter !== 'string') {
    console.error('colLetterToIndex: invalid input:', letter);
    return 1; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ª–æ–Ω–∫—É A –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  }

  letter = letter.toUpperCase();
  let col = 0;
  for (let i = 0; i < letter.length; i++) {
    col = col * 26 + (letter.charCodeAt(i) - 64);
  }
  return col;
}

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–∞ –≤ –±—É–∫–≤—É –∫–æ–ª–æ–Ω–∫–∏
function colIndexToLetter(index) {
  let result = '';
  while (index > 0) {
    index--;
    result = String.fromCharCode(65 + (index % 26)) + result;
    index = Math.floor(index / 26);
  }
  return result;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ü–≤–µ—Ç –∫—Ä–∞—Å–Ω—ã–º
function isRedColor(hexColor) {
  const lowerColor = String(hexColor || '').toLowerCase();
  if (CONFIG.redColors.has(lowerColor)) return true;

  // RGB –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∫—Ä–∞—Å–Ω—ã—Ö –æ—Ç—Ç–µ–Ω–∫–æ–≤
  if (!/^#[0-9a-fA-F]{6}$/.test(hexColor)) return false;
  const r = parseInt(hexColor.slice(1, 3), 16);
  const g = parseInt(hexColor.slice(3, 5), 16);
  const b = parseInt(hexColor.slice(5, 7), 16);
  return r >= 200 && g <= 90 && b <= 90;
}

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ª–∏—Å—Ç—ã –∫–æ–º–∞–Ω–¥
function getTeamSheets(spreadsheet) {
  if (!spreadsheet) {
    console.error('getTeamSheets: spreadsheet is undefined!');
    return [];
  }

  try {
    return spreadsheet.getSheets().filter(sheet =>
      /^Team\s+\d+/i.test(sheet.getName())
    );
  } catch (e) {
    console.error('Error in getTeamSheets:', e);
    return [];
  }
}

// –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–¥–µ–ª—å–Ω–æ–º –±–ª–æ–∫–µ –ø–æ –Ω–æ–º–µ—Ä—É –Ω–µ–¥–µ–ª–∏
function getWeekBlockInfo(weekNumber) {
  if (!weekNumber || weekNumber === undefined) {
    console.error('getWeekBlockInfo: weekNumber is undefined or null!');
    return null;
  }

  const weekKey = `week${weekNumber}`;
  const block = TABLE_STRUCTURE.weekBlocks[weekKey];

  if (!block) {
    console.error(`Week ${weekNumber} (${weekKey}) not found in TABLE_STRUCTURE`);
    console.error('Available weeks:', Object.keys(TABLE_STRUCTURE.weekBlocks));
    return null;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
  if (!block.day1 || !block.weekGross || !block.notes) {
    console.error(`Week ${weekNumber} has missing fields:`, block);
    return null;
  }

  try {
    console.log(`Processing week ${weekNumber}, block:`, JSON.stringify(block));

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –ø–æ–ª–µ –ø–µ—Ä–µ–¥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π
    const daysArray = [
      block.day1, block.day2, block.day3, block.day4,
      block.day5, block.day6, block.day7
    ];

    console.log(`Week ${weekNumber} days:`, daysArray);

    // –ù–∞—Ö–æ–¥–∏–º undefined
    const undefinedIndex = daysArray.findIndex(d => !d);
    if (undefinedIndex !== -1) {
      console.error(`Week ${weekNumber} has undefined day at index ${undefinedIndex}`);
      return null;
    }

    return {
      weekNumber: weekNumber,
      day1Col: colLetterToIndex(block.day1),
      weekGrossCol: colLetterToIndex(block.weekGross),
      notesCol: colLetterToIndex(block.notes),
      daysColumns: daysArray.map(col => colLetterToIndex(col))
    };
  } catch (e) {
    console.error(`Error processing week ${weekNumber}:`, e);
    return null;
  }
}

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–µ–¥–µ–ª–∏
function getAvailableWeeks() {
  return Object.keys(TABLE_STRUCTURE.weekBlocks).map(key => {
    return parseInt(key.replace('week', ''));
  }).sort((a, b) => b - a); // –æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º
}

// –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é –∏ –ø—Ä–µ–¥—ã–¥—É—â—É—é –Ω–µ–¥–µ–ª–∏
function getCurrentAndPreviousWeeks() {
  const allWeeks = getAvailableWeeks();
  console.log('All available weeks:', allWeeks);

  // –ë–µ—Ä–µ–º 2 –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–µ–¥–µ–ª–∏ (—Ç–µ–∫—É—â–∞—è + –ø—Ä–µ–¥—ã–¥—É—â–∞—è)
  const result = allWeeks.slice(0, 2);
  console.log('Current and previous weeks:', result);
  return result;
}

/************** DATE PARSING **************/

// –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
function parseDateFromHeader(headerText) {
  if (!headerText) return null;

  // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
  const dayMatch = headerText.match(/\b(\d{1,2})\b/);
  if (!dayMatch) return null;

  const day = parseInt(dayMatch[1]);

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
  let dayName = 'Day';
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  for (const name of dayNames) {
    if (headerText.toLowerCase().includes(name.toLowerCase())) {
      dayName = name;
      break;
    }
  }

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—è—Ü
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentDay = now.getDate();
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

  let monthIndex = currentMonth;
  if (day > currentDay + 7) {
    monthIndex = currentMonth === 0 ? 11 : currentMonth - 1;
  } else if (day < currentDay - 7) {
    monthIndex = currentMonth === 11 ? 0 : currentMonth + 1;
  }

  return {
    day: day,
    dayName: dayName,
    monthName: monthNames[monthIndex]
  };
}

// –ù–∞–π—Ç–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –≤–æ –≤—Å–µ—Ö –Ω–µ–¥–µ–ª—å–Ω—ã—Ö –±–ª–æ–∫–∞—Ö
function findAvailableDates(spreadsheet) {
  const teamSheets = getTeamSheets(spreadsheet);
  const availableDates = [];

  console.log('Team sheets found:', teamSheets.length);

  // –¢–û–õ–¨–ö–û —Ç–µ–∫—É—â–∞—è –∏ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª–∏
  const availableWeeks = getCurrentAndPreviousWeeks();
  console.log('Available weeks:', availableWeeks);

  // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —á—Ç–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  if (teamSheets.length === 0) {
    console.error('No team sheets found!');
    return [];
  }
  const sheet = teamSheets[0];
  console.log('Using sheet:', sheet.getName());

  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –ø–æ –ß–∏–∫–∞–≥–æ
  const now = new Date();
  const chicagoTime = Utilities.formatDate(now, CONFIG.timezone, 'yyyy-MM-dd');
  const currentDay = parseInt(chicagoTime.split('-')[2]);
  const currentMonth = parseInt(chicagoTime.split('-')[1]);
  console.log('Current Chicago date:', chicagoTime, 'Day:', currentDay, 'Month:', currentMonth);

  // –ü—Ä–æ—Ö–æ–¥–∏–º –¢–û–õ–¨–ö–û –ø–æ —Ç–µ–∫—É—â–µ–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –Ω–µ–¥–µ–ª—è–º
  for (const weekNumber of availableWeeks) {
    console.log(`Processing week ${weekNumber}`);
    const blockInfo = getWeekBlockInfo(weekNumber);
    if (!blockInfo) {
      console.error(`No block info for week ${weekNumber}`);
      continue;
    }
    console.log(`Block info for week ${weekNumber}:`, blockInfo);

    try {
      // –ß–∏—Ç–∞–µ–º –†–ï–ê–õ–¨–ù–´–ï –î–ê–¢–´ –∏–∑ —Å—Ç—Ä–æ–∫–∏ 1 (–Ω–∞–ø—Ä–∏–º–µ—Ä: "29-Sep", "30-Sep", "1-Oct")
      const dateVals = sheet.getRange(1, blockInfo.day1Col, 1, 7).getDisplayValues()[0];

      // –ü–∞—Ä—Å–∏–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
      for (let d = 0; d < 7; d++) {
        const dateText = String(dateVals[d] || '').trim();
        if (!dateText) continue;

        // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ "29-Sep" –∏–ª–∏ "1-Oct"
        const dateMatch = dateText.match(/(\d{1,2})-([A-Za-z]{3})/);
        if (dateMatch) {
          const day = parseInt(dateMatch[1]);
          const monthAbbr = dateMatch[2];

          // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –º–µ—Å—è—Ü –≤ –Ω–æ–º–µ—Ä
          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                              'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const monthNum = monthNames.indexOf(monthAbbr) + 1;

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É)
          const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
          let dayName = 'Day'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–∞–∫–æ–π –¥–∞—Ç—ã –µ—â–µ –Ω–µ—Ç
          const exists = availableDates.some(existing =>
            existing.day === day && existing.monthName === monthAbbr
          );

          if (!exists) {
            availableDates.push({
              day: day,
              dayName: dayName,
              monthName: monthAbbr,
              monthNum: monthNum,
              index: availableDates.length,
              weekNumber: weekNumber,
              dayIndex: d, // 0-6
              colIndex: blockInfo.daysColumns[d],
              blockInfo: blockInfo,
              originalText: dateText
            });
          }
        }
      }
    } catch (e) {
      console.error(`Error reading week ${weekNumber}:`, e);
      continue;
    }
  }

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å—Ç–∞—Ä—ã–µ ‚Üí –Ω–æ–≤—ã–µ)
  availableDates.sort((a, b) => {
    // –°–Ω–∞—á–∞–ª–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –Ω–µ–¥–µ–ª–∏
    if (a.weekNumber !== b.weekNumber) {
      return a.weekNumber - b.weekNumber; // WEEK 40 –ø–µ—Ä–µ–¥ WEEK 41
    }
    // –í–Ω—É—Ç—Ä–∏ –Ω–µ–¥–µ–ª–∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–Ω–¥–µ–∫—Å—É –¥–Ω—è
    return a.dayIndex - b.dayIndex;
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
  availableDates.forEach((date, index) => {
    date.index = index;
  });

  return availableDates;
}

/************** HTML DIALOG **************/

function createDateRangeDialog(availableDates) {
  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –ø–æ –ß–∏–∫–∞–≥–æ
  const now = new Date();
  const chicagoTime = Utilities.formatDate(now, CONFIG.timezone, 'yyyy-MM-dd');
  const currentDay = parseInt(chicagoTime.split('-')[2]);
  const currentMonth = parseInt(chicagoTime.split('-')[1]);

  // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
  let todayIndex = availableDates.length - 1; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ—Å–ª–µ–¥–Ω—è—è
  let yesterdayIndex = Math.max(0, todayIndex - 1); // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω—è—è

  // –ò—â–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
  for (let i = availableDates.length - 1; i >= 0; i--) {
    const date = availableDates[i];
    if (date.day === currentDay && date.monthNum === currentMonth) {
      todayIndex = i;
      yesterdayIndex = Math.max(0, i - 1);
      break;
    }
    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–∞ –¥–Ω—é –∏–∑ —Å–ø–∏—Å–∫–∞, –±–µ—Ä–µ–º –µ—ë
    if (date.day <= currentDay && date.monthNum === currentMonth) {
      todayIndex = i;
      yesterdayIndex = Math.max(0, i - 1);
      break;
    }
  }

  const dateOptions = availableDates.map((d, index) =>
    `<option value="${index}">${d.day}-${d.monthName} (WEEK ${d.weekNumber})</option>`
  ).join('');

  return `
    <html>
      <head>
        <style>
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }

          body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 0;
            background: transparent;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
          }

          .container {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 420px;
            max-height: 400px;
            animation: slideIn 0.3s ease-out;
          }

          @keyframes slideIn {
            from {
              opacity: 0;
              transform: translateY(-20px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }

          .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 18px;
          }

          .icon {
            font-size: 24px;
          }

          h3 {
            color: #2d3748;
            font-size: 20px;
            font-weight: 600;
          }

          .form-group {
            margin-bottom: 14px;
          }

          label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
          }

          .badge {
            background: #edf2f7;
            color: #667eea;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
          }

          select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            color: #2d3748;
            background: white;
            transition: all 0.2s ease;
            cursor: pointer;
          }

          select:hover {
            border-color: #cbd5e0;
          }

          select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
          }

          .buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
          }

          button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            flex: 1;
          }

          .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
          }

          .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
          }

          .btn-primary:active {
            transform: translateY(0);
          }

          .btn-secondary {
            background: white;
            color: #718096;
            border: 2px solid #e2e8f0;
          }

          .btn-secondary:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
          }

          .info-text {
            text-align: center;
            color: #a0aec0;
            font-size: 12px;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid #e2e8f0;
          }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <span class="icon">üìÖ</span>
            <h3>Select Date Range</h3>
          </div>

          <div class="form-group">
            <label>
              <span>Start Date</span>
              <span class="badge" id="startWeek"></span>
            </label>
            <select id="startDate" onchange="updateWeekBadge()">
              ${dateOptions}
            </select>
          </div>

          <div class="form-group">
            <label>
              <span>End Date</span>
              <span class="badge" id="endWeek"></span>
            </label>
            <select id="endDate" onchange="updateWeekBadge()">
              ${dateOptions}
            </select>
          </div>

          <div class="info-text">
            Find drivers with RED READY status
          </div>

          <div class="buttons">
            <button class="btn-secondary" onclick="cancel()">Cancel</button>
            <button class="btn-primary" onclick="submit()">Create Report</button>
          </div>
        </div>

        <script>
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—á–µ—Ä–∞ –∏ —Å–µ–≥–æ–¥–Ω—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –ø–æ –ß–∏–∫–∞–≥–æ)
          const YESTERDAY_INDEX = ${yesterdayIndex};
          const TODAY_INDEX = ${todayIndex};

          window.onload = function() {
            const startSelect = document.getElementById('startDate');
            const endSelect = document.getElementById('endDate');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—á–µ—Ä–∞ –∫–∞–∫ startDate
            startSelect.value = YESTERDAY_INDEX;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è –∫–∞–∫ endDate
            endSelect.value = TODAY_INDEX;

            updateWeekBadge();
          };

          function updateWeekBadge() {
            const startSelect = document.getElementById('startDate');
            const endSelect = document.getElementById('endDate');

            const startText = startSelect.options[startSelect.selectedIndex].text;
            const endText = endSelect.options[endSelect.selectedIndex].text;

            // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞
            const startWeekMatch = startText.match(/WEEK (\\d+)/);
            const endWeekMatch = endText.match(/WEEK (\\d+)/);

            if (startWeekMatch) {
              document.getElementById('startWeek').textContent = 'Week ' + startWeekMatch[1];
            }
            if (endWeekMatch) {
              document.getElementById('endWeek').textContent = 'Week ' + endWeekMatch[1];
            }
          }

          function submit() {
            const startIndex = document.getElementById('startDate').value;
            const endIndex = document.getElementById('endDate').value;

            if (parseInt(startIndex) > parseInt(endIndex)) {
              alert('‚ö†Ô∏è Start date must be before end date!');
              return;
            }

            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —á—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –Ω–∞–∂–∞—Ç—å –¥–≤–∞–∂–¥—ã
            const btn = event.target;
            btn.disabled = true;

            // –ê–Ω–∏–º–∞—Ü–∏—è —Ç–æ—á–µ–∫ "Processing..."
            let dots = 0;
            const animateInterval = setInterval(function() {
              dots = (dots + 1) % 4;
              btn.textContent = 'Processing' + '.'.repeat(dots);
            }, 500);

            const result = JSON.stringify({
              startIndex: parseInt(startIndex),
              endIndex: parseInt(endIndex)
            });

            // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É, –∑–∞–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            google.script.run.processSelectedDateRange(result);
            setTimeout(function() {
              clearInterval(animateInterval);
              google.script.host.close();
            }, 2000);
          }

          function cancel() {
            google.script.host.close();
          }
        </script>
      </body>
    </html>
  `;
}

/************** SEPARATOR MANAGEMENT **************/

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π
function getAllSeparatorColumns() {
  const separators = [];

  console.log('Getting separator columns...');

  // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π)
  if (TABLE_STRUCTURE.separators) {
    if (TABLE_STRUCTURE.separators.afterDrivers) {
      separators.push(TABLE_STRUCTURE.separators.afterDrivers); // G
    }
    if (TABLE_STRUCTURE.separators.afterWeek34) {
      separators.push(TABLE_STRUCTURE.separators.afterWeek34);  // L
    }
  }

  // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –∏–∑ –∫–∞–∂–¥–æ–≥–æ –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞
  for (const weekKey in TABLE_STRUCTURE.weekBlocks) {
    const block = TABLE_STRUCTURE.weekBlocks[weekKey];

    console.log(`Processing ${weekKey}:`, {
      separator: block.separator,
      separator2: block.separator2,
      separator3: block.separator3
    });

    if (block.separator) separators.push(block.separator);
    if (block.separator2) separators.push(block.separator2);
    if (block.separator3) separators.push(block.separator3);
  }

  console.log('Total separators found:', separators.length);
  return separators;
}

// –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –∏ —Ü–≤–µ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π
function fixSeparators() {
  const ss = SpreadsheetApp.getActive();
  const teamSheets = getTeamSheets(ss);

  console.log('=== Fix Separators Started ===');

  if (teamSheets.length === 0) {
    SpreadsheetApp.getUi().alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ª–∏—Å—Ç–æ–≤ –∫–æ–º–∞–Ω–¥.');
    return;
  }

  const separatorColumns = getAllSeparatorColumns();
  console.log('Separator columns:', separatorColumns);

  const separatorColor = '#434343';
  const separatorWidth = 38; // –ø–∏–∫—Å–µ–ª–µ–π

  let fixedCount = 0;

  for (const sheet of teamSheets) {
    try {
      const lastRow = sheet.getLastRow();

      for (const colLetter of separatorColumns) {
        console.log('Processing separator column:', colLetter);
        if (!colLetter) {
          console.error('Undefined separator column!');
          continue;
        }
        const colIndex = colLetterToIndex(colLetter);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–∫–∏
        sheet.setColumnWidth(colIndex, separatorWidth);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –¥–ª—è –≤—Å–µ–π –∫–æ–ª–æ–Ω–∫–∏
        if (lastRow > 0) {
          sheet.getRange(1, colIndex, lastRow, 1).setBackground(separatorColor);
        }
      }

      fixedCount++;
    } catch (e) {
      console.error(`–û—à–∏–±–∫–∞ –¥–ª—è ${sheet.getName()}:`, e);
    }
  }

  SpreadsheetApp.getUi().alert(`–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –≤ ${fixedCount} –ª–∏—Å—Ç–∞—Ö.\n–®–∏—Ä–∏–Ω–∞: ${separatorWidth}px, –¶–≤–µ—Ç: ${separatorColor}`);
}

/************** MENU **************/

function onOpen() {
  try {
    SpreadsheetApp.getUi()
      .createMenu('Dispatch NEW')
      .addItem('üéØ READY Custom Date Range', 'buildReadyCustomDateRange')
      .addSeparator()
      .addItem('üîß Fix Separators', 'fixSeparators')
      .addSeparator()
      .addItem('üß™ Test All Functions', 'testAllFunctions')
      .addToUi();
  } catch (e) {
    console.error('Error in onOpen:', e);
  }
}

// –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
function testAllFunctions() {
  console.log('=== TESTING ALL FUNCTIONS ===\n');

  // 1. colLetterToIndex
  console.log('1. Testing colLetterToIndex:');
  try {
    console.log('  A =', colLetterToIndex('A'), '(expected: 1)');
    console.log('  Z =', colLetterToIndex('Z'), '(expected: 26)');
    console.log('  AA =', colLetterToIndex('AA'), '(expected: 27)');
    console.log('  CG =', colLetterToIndex('CG'), '(expected: 85)');
    console.log('  ‚úÖ colLetterToIndex works');
  } catch (e) {
    console.error('  ‚ùå colLetterToIndex failed:', e);
  }

  // 2. colIndexToLetter
  console.log('\n2. Testing colIndexToLetter:');
  try {
    console.log('  1 =', colIndexToLetter(1), '(expected: A)');
    console.log('  26 =', colIndexToLetter(26), '(expected: Z)');
    console.log('  27 =', colIndexToLetter(27), '(expected: AA)');
    console.log('  ‚úÖ colIndexToLetter works');
  } catch (e) {
    console.error('  ‚ùå colIndexToLetter failed:', e);
  }

  // 3. isRedColor
  console.log('\n3. Testing isRedColor:');
  try {
    console.log('  #ff0000 =', isRedColor('#ff0000'), '(expected: true)');
    console.log('  #00ff00 =', isRedColor('#00ff00'), '(expected: false)');
    console.log('  #ff6666 =', isRedColor('#ff6666'), '(expected: true)');
    console.log('  ‚úÖ isRedColor works');
  } catch (e) {
    console.error('  ‚ùå isRedColor failed:', e);
  }

  // 4. getTeamSheets
  console.log('\n4. Testing getTeamSheets:');
  try {
    const ss = SpreadsheetApp.getActive();
    const sheets = getTeamSheets(ss);
    console.log('  Found', sheets.length, 'team sheets');
    sheets.forEach(s => console.log('    -', s.getName()));
    console.log('  ‚úÖ getTeamSheets works');
  } catch (e) {
    console.error('  ‚ùå getTeamSheets failed:', e);
  }

  // 5. getAvailableWeeks
  console.log('\n5. Testing getAvailableWeeks:');
  try {
    const weeks = getAvailableWeeks();
    console.log('  Available weeks:', weeks);
    console.log('  ‚úÖ getAvailableWeeks works');
  } catch (e) {
    console.error('  ‚ùå getAvailableWeeks failed:', e);
  }

  // 6. getCurrentAndPreviousWeeks
  console.log('\n6. Testing getCurrentAndPreviousWeeks:');
  try {
    const weeks = getCurrentAndPreviousWeeks();
    console.log('  Current & Previous weeks:', weeks);
    console.log('  ‚úÖ getCurrentAndPreviousWeeks works');
  } catch (e) {
    console.error('  ‚ùå getCurrentAndPreviousWeeks failed:', e);
  }

  // 7. getWeekBlockInfo
  console.log('\n7. Testing getWeekBlockInfo:');
  try {
    const block40 = getWeekBlockInfo(40);
    console.log('  Week 40:', block40 ? '‚úÖ Found' : '‚ùå Not found');
    if (block40) {
      console.log('    day1Col:', block40.day1Col);
      console.log('    weekGrossCol:', block40.weekGrossCol);
    }

    const block41 = getWeekBlockInfo(41);
    console.log('  Week 41:', block41 ? '‚úÖ Found' : '‚ùå Not found');
    if (block41) {
      console.log('    day1Col:', block41.day1Col);
      console.log('    weekGrossCol:', block41.weekGrossCol);
    }
  } catch (e) {
    console.error('  ‚ùå getWeekBlockInfo failed:', e);
  }

  // 8. parseDateFromHeader
  console.log('\n8. Testing parseDateFromHeader:');
  try {
    const date1 = parseDateFromHeader('29-Sep');
    console.log('  "29-Sep" =>', date1);

    const date2 = parseDateFromHeader('5-Oct');
    console.log('  "5-Oct" =>', date2);
    console.log('  ‚úÖ parseDateFromHeader works');
  } catch (e) {
    console.error('  ‚ùå parseDateFromHeader failed:', e);
  }

  // 9. findAvailableDates
  console.log('\n9. Testing findAvailableDates:');
  try {
    const ss = SpreadsheetApp.getActive();
    const dates = findAvailableDates(ss);
    console.log('  Found', dates.length, 'dates');
    if (dates.length > 0) {
      console.log('  First date:', dates[0]);
      console.log('  Last date:', dates[dates.length - 1]);
    }
    console.log('  ‚úÖ findAvailableDates works');
  } catch (e) {
    console.error('  ‚ùå findAvailableDates failed:', e);
  }

  console.log('\n=== TEST COMPLETE ===');
}

/************** MAIN FUNCTION **************/

function buildReadyCustomDateRange() {
  const ss = SpreadsheetApp.getActive();
  const ui = SpreadsheetApp.getUi();

  console.log('=== Starting buildReadyCustomDateRange ===');

  // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã
  const availableDates = findAvailableDates(ss);

  console.log('Found dates:', availableDates.length);

  if (availableDates.length === 0) {
    ui.alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –¥–∞—Ç—ã.');
    return;
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ processSelectedDateRange
  PropertiesService.getScriptProperties().setProperty('availableDates', JSON.stringify(availableDates));

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞
  const dateRangeDialog = createDateRangeDialog(availableDates);
  const htmlOutput = HtmlService.createHtmlOutput(dateRangeDialog)
    .setWidth(420)
    .setHeight(340);

  ui.showModalDialog(htmlOutput, 'Select Date Range for READY');

  // –§—É–Ω–∫—Ü–∏—è –ó–ê–ö–ê–ù–ß–ò–í–ê–ï–¢–°–Ø –∑–¥–µ—Å—å - –∂–¥–µ–º –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º–µ—Ç –∫–Ω–æ–ø–∫—É
}

// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "Create Report" –≤ –¥–∏–∞–ª–æ–≥–µ
function processSelectedDateRange(rangeDataJson) {
  const ss = SpreadsheetApp.getActive();

  console.log('=== Processing selected date range ===');

  // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã
  const availableDatesJson = PropertiesService.getScriptProperties().getProperty('availableDates');
  const availableDates = JSON.parse(availableDatesJson);

  const rangeData = JSON.parse(rangeDataJson);
  const startDateInfo = availableDates[rangeData.startIndex];
  const endDateInfo = availableDates[rangeData.endIndex];

  // –û—á–∏—â–∞–µ–º properties
  PropertiesService.getScriptProperties().deleteProperty('availableDates');

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤—ã–±—Ä–∞–ª –¥–∞—Ç—ã!
  ss.toast(`Searching for drivers with READY...`, '‚è≥ Processing', 10);

  // –°–æ–∑–¥–∞—ë–º –æ—Ç—á—ë—Ç (–ë–ï–ó timestamp)
  generateReadyReport(ss, availableDates, rangeData, startDateInfo, endDateInfo);
}

/************** REPORT GENERATION **************/

function generateReadyReport(spreadsheet, availableDates, rangeData, startDateInfo, endDateInfo) {
  const outName = `READY ${startDateInfo.day}-${startDateInfo.monthName} to ${endDateInfo.day}-${endDateInfo.monthName}`;

  spreadsheet.toast('Creating report sheet...', '‚è≥ Step 1/3', 3);

  let outSheet = spreadsheet.getSheetByName(outName);
  if (outSheet) {
    outSheet.clear();
  } else {
    outSheet = spreadsheet.insertSheet(outName);
  }

  // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–µ–≤—ã–µ –¥–∞—Ç—ã
  const targetDates = availableDates.slice(rangeData.startIndex, rangeData.endIndex + 1);

  if (targetDates.length === 0) {
    outSheet.getRange('A1').setValue('No dates in selected range.');
    spreadsheet.toast('‚ùå No dates', 'Error', 3);
    return;
  }

  spreadsheet.toast(`Searching READY in ${targetDates.length} dates...`, '‚è≥ Step 2/3', 5);

  // –°–æ–±–∏—Ä–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (–≤–æ–¥–∏—Ç–µ–ª–µ–π —Å RED READY –Ω–∞ –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞—Ç–∞—Ö)
  const candidates = findReadyCandidates(spreadsheet, targetDates);

  if (candidates.length === 0) {
    outSheet.getRange('A1').setValue('No drivers with RED READY found on all selected dates.');
    spreadsheet.toast('‚ùå No drivers found', 'Done', 3);
    return;
  }

  spreadsheet.toast(`Found ${candidates.length} drivers. Creating report...`, '‚è≥ Step 3/3', 5);

  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—Ç—á—ë—Ç
  writeReadyReport(outSheet, candidates, targetDates, spreadsheet);
}

function findReadyCandidates(spreadsheet, targetDates) {
  const candidates = [];
  const teamSheets = getTeamSheets(spreadsheet);

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
  let processedTeams = 0;

  for (const sheet of teamSheets) {
    const lastRow = sheet.getLastRow();
    if (lastRow < CONFIG.dataStartRow) continue;

    const numRows = lastRow - CONFIG.dataStartRow + 1;

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞—Ç—ã –ø–æ –Ω–µ–¥–µ–ª—è–º –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è
    const weekGroups = new Map();
    for (const date of targetDates) {
      if (!weekGroups.has(date.weekNumber)) {
        weekGroups.set(date.weekNumber, []);
      }
      weekGroups.get(date.weekNumber).push(date);
    }

    // –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–µ–¥–µ–ª–∏
    const weekData = new Map();
    for (const [weekNumber, dates] of weekGroups) {
      const blockInfo = dates[0].blockInfo;
      try {
        const vals = sheet.getRange(CONFIG.dataStartRow, blockInfo.day1Col, numRows, 7).getValues();
        const bgs = sheet.getRange(CONFIG.dataStartRow, blockInfo.day1Col, numRows, 7).getBackgrounds();
        weekData.set(weekNumber, { vals, bgs, blockInfo });
      } catch (e) {
        console.error(`Error reading week ${weekNumber}:`, e);
      }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è
    for (let i = 0; i < numRows; i++) {
      let allDaysReady = true;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –í–°–ï —Ü–µ–ª–µ–≤—ã–µ –¥–∞—Ç—ã = RED READY
      for (const date of targetDates) {
        const data = weekData.get(date.weekNumber);
        if (!data) {
          allDaysReady = false;
          break;
        }

        const dayVal = String(data.vals[i][date.dayIndex] || '').trim().toLowerCase();
        const dayBg = String(data.bgs[i][date.dayIndex] || '');

        if (dayVal !== 'ready' || !isRedColor(dayBg)) {
          allDaysReady = false;
          break;
        }
      }

      if (allDaysReady) {
        candidates.push({
          sheet: sheet,
          row: CONFIG.dataStartRow + i,
          targetDates: targetDates
        });
      }
    }
  }

  return candidates;
}

function writeReadyReport(outSheet, candidates, targetDates, spreadsheet) {
  const firstSheet = candidates[0].sheet;
  const lastDate = targetDates[targetDates.length - 1];

  // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–µ–¥–µ–ª–∏ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞—Ç
  const uniqueWeeks = [...new Set(targetDates.map(d => d.weekNumber))].sort((a, b) => a - b);

  const totalCols = 2 + targetDates.length + uniqueWeeks.length + 1; // E:F + dates + WEEK GROSS'—ã + NOTES
  const totalRows = candidates.length + 1; // +1 –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞

  // === –®–ê–ü–ö–ê - –∫–æ–ø–∏—Ä—É–µ–º –≤—Å—ë –æ–¥–Ω–∏–º –±–∞—Ç—á–µ–º ===
  let outCol = 1;

  // E:F (Dispatcher, Driver)
  firstSheet.getRange(1, colLetterToIndex(TABLE_STRUCTURE.base.dispatcher), 1, 2)
            .copyTo(outSheet.getRange(1, outCol, 1, 2));
  outCol += 2;

  // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–∞—Ç
  for (const date of targetDates) {
    firstSheet.getRange(1, date.colIndex, 1, 1)
              .copyTo(outSheet.getRange(1, outCol, 1, 1));
    outCol++;
  }

  // WEEK GROSS –¥–ª—è –∫–∞–∂–¥–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –Ω–µ–¥–µ–ª–∏
  for (const weekNum of uniqueWeeks) {
    const weekBlockInfo = getWeekBlockInfo(weekNum);
    if (weekBlockInfo) {
      firstSheet.getRange(1, weekBlockInfo.weekGrossCol, 1, 1)
                .copyTo(outSheet.getRange(1, outCol, 1, 1));
      outCol++;
    }
  }

  // NOTES (–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–∞—Ç—ã)
  firstSheet.getRange(1, lastDate.blockInfo.notesCol, 1, 1)
            .copyTo(outSheet.getRange(1, outCol, 1, 1));

  // === –î–ê–ù–ù–´–ï - —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç—ã –≤ –º–∞—Å—Å–∏–≤—ã ===
  const allValues = [];
  const allBackgrounds = [];
  const allFontColors = [];
  const allFontWeights = [];
  const allNumberFormats = [];

  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ª–∏—Å—Ç–∞–º –¥–ª—è –±–∞—Ç—á-—á—Ç–µ–Ω–∏—è
  const sheetGroups = new Map();
  for (const candidate of candidates) {
    const sheetName = candidate.sheet.getName();
    if (!sheetGroups.has(sheetName)) {
      sheetGroups.set(sheetName, []);
    }
    sheetGroups.get(sheetName).push(candidate);
  }

  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –ª–∏—Å—Ç –æ—Ç–¥–µ–ª—å–Ω–æ
  for (const [sheetName, groupCandidates] of sheetGroups) {
    const sheet = groupCandidates[0].sheet;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –≤—Å–µ—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    const colsToRead = [];

    // E:F (Dispatcher, Driver)
    colsToRead.push(colLetterToIndex(TABLE_STRUCTURE.base.dispatcher));
    colsToRead.push(colLetterToIndex(TABLE_STRUCTURE.base.driver));

    // –í—Å–µ –¥–∞—Ç—ã
    for (const date of targetDates) {
      colsToRead.push(date.colIndex);
    }

    // WEEK GROSS –¥–ª—è –∫–∞–∂–¥–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –Ω–µ–¥–µ–ª–∏
    const weekGrossColumns = [];
    for (const weekNum of uniqueWeeks) {
      const weekBlockInfo = getWeekBlockInfo(weekNum);
      if (weekBlockInfo) {
        colsToRead.push(weekBlockInfo.weekGrossCol);
        weekGrossColumns.push(weekBlockInfo.weekGrossCol);
      }
    }

    // NOTES
    colsToRead.push(lastDate.blockInfo.notesCol);

    // –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –∫–æ–ª–æ–Ω–∫–∏
    const minCol = Math.min(...colsToRead);
    const maxCol = Math.max(...colsToRead);
    const colCount = maxCol - minCol + 1;

    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –±–∞—Ç—á-—á—Ç–µ–Ω–∏—è
    const rows = groupCandidates.map(c => c.row);
    const minRow = Math.min(...rows);
    const maxRow = Math.max(...rows);
    const rowCount = maxRow - minRow + 1;

    // –ß–ò–¢–ê–ï–ú –í–°–ï –î–ê–ù–ù–´–ï –û–î–ù–ò–ú –û–ì–†–û–ú–ù–´–ú –ë–ê–¢–ß–ï–ú –¥–ª—è –≤—Å–µ—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π –∏–∑ —ç—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
    const bigRange = sheet.getRange(minRow, minCol, rowCount, colCount);
    const allVals = bigRange.getValues();
    const allBgs = bigRange.getBackgrounds();
    const allColors = bigRange.getFontColors();
    const allWeights = bigRange.getFontWeights();
    const allDisplayVals = bigRange.getDisplayValues();
    const allFormats = bigRange.getNumberFormats();

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
    for (const candidate of groupCandidates) {
      const row = candidate.row;
      const rowOffset = row - minRow;

      // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏
      const rowVals = allVals[rowOffset];
      const rowBgs = allBgs[rowOffset];
      const rowColors = allColors[rowOffset];
      const rowWeights = allWeights[rowOffset];
      const rowDisplayVals = allDisplayVals[rowOffset];
      const rowFormats = allFormats[rowOffset];

      // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω—É–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º
      const rowValues = [];
      const rowBackgrounds = [];
      const rowFontColors = [];
      const rowFontWeights = [];
      const rowNumberFormats = [];

      for (const col of colsToRead) {
        const offset = col - minCol;

        // –î–ª—è WEEK GROSS –∫–æ–ª–æ–Ω–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º displayValue –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —á–∏—Å–ª–æ
        if (weekGrossColumns.includes(col)) {
          const weekGrossValue = rowDisplayVals[offset];
          // –£–¥–∞–ª—è–µ–º $ –∏ –∑–∞–ø—è—Ç—ã–µ, –∑–∞—Ç–µ–º –ø–∞—Ä—Å–∏–º
          const cleanValue = String(weekGrossValue).replace(/[$,]/g, '').trim();
          const weekGrossNumber = parseFloat(cleanValue) || 0;
          rowValues.push(weekGrossNumber);
        } else {
          rowValues.push(rowVals[offset]);
        }

        rowBackgrounds.push(rowBgs[offset]);
        rowFontColors.push(rowColors[offset]);
        rowFontWeights.push(rowWeights[offset]);
        rowNumberFormats.push(rowFormats[offset]);
      }

      allValues.push(rowValues);
      allBackgrounds.push(rowBackgrounds);
      allFontColors.push(rowFontColors);
      allFontWeights.push(rowFontWeights);
      allNumberFormats.push(rowNumberFormats);
    }
  }

  // === –ó–ê–ü–ò–°–´–í–ê–ï–ú –í–°–Å –û–î–ù–ò–ú –ë–ê–¢–ß–ï–ú ===
  if (allValues.length > 0) {
    const dataRange = outSheet.getRange(2, 1, allValues.length, totalCols);
    dataRange.setValues(allValues);
    dataRange.setBackgrounds(allBackgrounds);
    dataRange.setFontColors(allFontColors);
    dataRange.setFontWeights(allFontWeights);
    dataRange.setNumberFormats(allNumberFormats);
  }

  // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å—ë —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–∏–º –±–æ–ª—å—à–∏–º –±–ª–æ–∫–æ–º
  const fullRange = outSheet.getRange(1, 1, totalRows, totalCols);

  fullRange.setBorder(
    true, true, true, true, true, true,
    'black',
    SpreadsheetApp.BorderStyle.SOLID_MEDIUM
  )
  .setFontWeight('bold')
  .setHorizontalAlignment('center');

  // –ë–µ–ª—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  outSheet.getRange(1, 1, 1, totalCols).setFontColor('white');

  // –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏ + 0.7—Å–º padding
  for (let c = 1; c <= totalCols; c++) {
    outSheet.autoResizeColumn(c);
    const currentWidth = outSheet.getColumnWidth(c);
    outSheet.setColumnWidth(c, currentWidth + 26); // +0.7—Å–º ‚âà 26 –ø–∏–∫—Å–µ–ª–µ–π
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  const ss = SpreadsheetApp.getActive();
  ss.toast(`‚úÖ Found ${candidates.length} drivers`, 'Done!', 5);

  SpreadsheetApp.getUi().alert(`‚úÖ Report Created!\n\nDrivers found: ${candidates.length}\nDate range: ${targetDates[0].day}-${targetDates[0].monthName} to ${lastDate.day}-${lastDate.monthName}`);
}
